<html>

<head>
    <title>Tasks</title>
    <link rel="stylesheet" href="layout.css" />
    <link rel="stylesheet" href="style.css" />
</head>

<body>
    <div class="layout-flex">
        <div class="unschedule layout-flex flex-column justify-between">
            <div>
                <h2>Tasks <br />(Un-scheduled)</h2>
                <div id="taskList" class="tasks">
                </div>
            </div>
            <div class="settings layout-flex flex-column">
                <h4>Settings</h4>
                <label>Start Time: <input id="startTime" type="time" /></label>
                <label>End Time: <input id="endTime" type="time" /></label>
            </div>
        </div>
        <div class="flex-1">
            <h2>Day View</h2>
            <div class="wrapper-time-graph">
                <div class="days-name layout-flex">
                    <div class="time"></div>
                    <h4 class="flex-1">Monday</h4>
                    <h4 class="flex-1">Tuesday</h4>
                    <h4 class="flex-1">Wednesday</h4>
                    <h4 class="flex-1">Thursday</h4>
                    <h4 class="flex-1">Friday</h4>
                </div>
                <div class="time-graph layout-flex">
                    <div class="time">
                        <div>12am</div>
                        <div>01am</div>
                        <div>02am</div>
                        <div>03am</div>
                        <div>04am</div>
                        <div>05am</div>
                        <div>06am</div>
                        <div>07am</div>
                        <div>08am</div>
                        <div>09am</div>
                        <div>10am</div>
                        <div>11am</div>
                        <div>12pm</div>
                        <div>01pm</div>
                        <div>02pm</div>
                        <div>03pm</div>
                        <div>04pm</div>
                        <div>05pm</div>
                        <div>06pm</div>
                        <div>07pm</div>
                        <div>08pm</div>
                        <div>09pm</div>
                        <div>10pm</div>
                        <div>11pm</div>
                    </div>
                    <div class="days flex-1 layout-flex">
                        <div class="day flex-1">
                        </div>
                        <div class="day flex-1"></div>
                        <div class="day flex-1"></div>
                        <div class="day flex-1"></div>
                        <div class="day flex-1"></div>
                    </div>
                    <div class="time-now">
                        <span></span>
                    </div>
                    <div class="time-highlight"></div>
                    <div class="time-highlight"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // const tasks = [{ id: 1, title: 'Do Chores' }, { id: 2, title: 'Fill tank' },]

        /// write down logic to create task elements in HTML

        const tasksArray = [{ id: 1, name: "Task 1" }, { id: 2, name: "Task 2" },
        { id: 3, name: "Task 3" },
        { name: 'Do chores', start: new Date(2024, 6, 15, 15), end: new Date(2024, 6, 15, 16) }, { name: 'Fill Tank', start: new Date(2024, 6, 13), end: new Date(2024, 6, 18, 1) }];
        // Function to create task elements and append to task list
        function createTasks(tasks) {
            const taskList = document.getElementById("taskList");
            const taskDays = document.querySelectorAll(".day");

            const graphStartDate = new Date();
            graphStartDate.setHours(0)
            graphStartDate.setMinutes(0)
            graphStartDate.setSeconds(0)
            graphStartDate.setMilliseconds(0)

            const day = graphStartDate.getDay()
            if (day > 0 && day < 6) {
                graphStartDate.setDate(graphStartDate.getDate() + day - (day * 2) + 1)
            } else {
                graphStartDate.setDate(graphStartDate.getDate() + (day === 6 ? 2 : 1))
            }

            const graphEndDate = new Date(graphStartDate)
            graphEndDate.setDate(graphEndDate.getDate() + 4);
            console.log(graphStartDate, graphEndDate)
            tasks.forEach(task => {
                if (task.start && task.start >= graphStartDate && task.start <= graphEndDate) {
                    const taskDayIndex = task.start.getDay() - 1;

                    const taskDiv = document.createElement("div");
                    taskDiv.className = 'task';
                    taskDiv.draggable = true;
                    taskDiv.textContent = task.name;

                    // offset
                    // task.style.top = 
                    // duration
                    // task.style.height =  

                    taskDays[taskDayIndex].appendChild(taskDiv)
                    return;
                } else if (!task.start) {
                    const taskDiv = document.createElement("div");
                    taskDiv.className = 'task';
                    taskDiv.draggable = true;
                    taskDiv.textContent = task.name;
                    taskList.appendChild(taskDiv);
                }
            });
        }

        // Initial call to create tasks
        createTasks(tasksArray);


        const dragzones = [
            document.querySelector(".tasks"),
            ...document.querySelectorAll(".day"),
        ];

        const tasksElm = document.querySelectorAll(".task");

        let dragElm = null;

        for (const dragzone of dragzones) {
            dragzone.addEventListener("dragover", (e) => {
                if (e.target === dragzone) e.preventDefault();
            });
            dragzone.addEventListener("dragenter", (e) => {
                if (e.target === dragzone)
                    e.target.classList.add("drag-target-active");
            });
            dragzone.addEventListener("dragleave", (e) => {
                if (e.target === dragzone)
                    e.target.classList.remove("drag-target-active");
            });
            dragzone.addEventListener("drop", (e) => {
                e.target.classList.remove("drag-target-active");
                if (e.target === dragzone) {
                    e.preventDefault();
                    e.target.appendChild(dragElm);
                }
            });
        }

        for (const task of tasksElm) {
            task.addEventListener("dragstart", (e) => {
                dragElm = e.target;
            });
        }


        const cellSize = 26; // 15 min
        const pixelPerMinute = cellSize / 15;

        const startTimeElm = document.querySelector('#startTime');
        const endTimeElm = document.querySelector('#endTime');

        updateHighlight(startTimeElm.value, endTimeElm.value)

        startTimeElm.addEventListener('change', () => {
            updateHighlight(startTimeElm.value, endTimeElm.value)
        })

        endTimeElm.addEventListener('change', () => {
            updateHighlight(startTimeElm.value, endTimeElm.value)
        })

        function updateHighlight(startTime, endTime) {
            if (!startTime || !endTime) return;

            const startHourMin = startTime.split(':');
            const endHourMin = endTime.split(':');

            const startHour = parseInt(startHourMin[0]);
            const startMin = parseInt(startHourMin[1]);
            const endHour = parseInt(endHourMin[0]);
            const endMin = parseInt(endHourMin[1]);

            const maxDuration = 2496;// 24 * 60 * pixelPerMinute;

            const offset = getOffset(startHour, startMin) * pixelPerMinute
            const duration = getDuration(startHour, startMin, endHour, endMin) * pixelPerMinute

            const highlightElm = document.querySelectorAll('.time-highlight');

            if (duration < 0) {
                highlightElm[0].style.top = offset;
                highlightElm[0].style.height = maxDuration - offset;

                highlightElm[1].style.top = 0;
                highlightElm[1].style.height = getDuration(0, 0, endHour, endMin) * pixelPerMinute
            } else {
                highlightElm[0].style.top = duration === 0 ? 0 : offset;
                highlightElm[0].style.height = duration === 0 ? maxDuration : duration;
                highlightElm[1].style.height = 0
            }
        }



        function getOffset(startHour, startMin) {
            return startHour * 60 + startMin;
        }

        function getDuration(startHour, startMin, endHour, endMin) {
            return (endHour * 60 + endMin) - (startHour * 60 + startMin)
        }



        updateTime();

        function updateTime() {
            const timeGraph = document.querySelector(".wrapper-time-graph");
            const timeNowElm = document.querySelector(".time-now");
            const timeNow = timeNowElm.querySelector("span");

            const now = new Date();

            const hours = now.getHours();
            const min = now.getMinutes();

            // scroll height
            const visibleGraphHeight = timeGraph.getClientRects()[0].height - 8;
            const scrollMarginInMinutes = visibleGraphHeight / 2 / pixelPerMinute;

            timeGraph.scrollTop =
                Math.max(0, hours * 60 + min - scrollMarginInMinutes) *
                pixelPerMinute;

            updateLinePosition(hours, min);
            displayTime(hours, min);

            setInterval(() => {
                const now = new Date();
                const hours = now.getHours();
                const min = now.getMinutes();

                updateLinePosition(hours, min);
                displayTime(hours, min);
            }, 1000);

            function updateLinePosition(hours, min) {
                // line position
                const height = (hours * 60 + min) * pixelPerMinute;
                timeNowElm.style.top = height;
            }

            function displayTime(hours, min) {
                // display time
                let _12hours = hours % 12;
                if (_12hours === 0) _12hours = 12;

                let ampm = hours >= 12 ? "pm" : "am";

                timeNow.textContent =
                    _12hours.toString().padStart(2, "0") +
                    ":" +
                    min.toString().padStart(2, "0") +
                    ampm;
            }
        }
    </script>
</body>

</html>