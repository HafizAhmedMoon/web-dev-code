<html>

<head>
    <title>Tasks</title>
    <link rel="stylesheet" href="layout.css" />
    <link rel="stylesheet" href="style.css" />
</head>

<body>
    <div class="layout-flex">
        <div class="unschedule layout-flex flex-column justify-between">
            <div>
                <h2>Tasks <br />(Un-scheduled)</h2>
                <div class="tasks">
                    <div class="task" draggable="true">Task 1</div>
                    <div class="task" draggable="true">Task 2</div>
                    <div class="task" draggable="true">Task 3</div>
                </div>
            </div>
            <div class="settings layout-flex flex-column">
                <h4>Settings</h4>
                <label>Start Time: <input id="startTime" type="time" /></label>
                <label>End Time: <input id="endTime" type="time" /></label>
            </div>
        </div>
        <div class="flex-1">
            <h2>Day View</h2>
            <div class="wrapper-time-graph">
                <div class="time-graph layout-flex">
                    <div class="time">
                        <div>12am</div>
                        <div>01am</div>
                        <div>02am</div>
                        <div>03am</div>
                        <div>04am</div>
                        <div>05am</div>
                        <div>06am</div>
                        <div>07am</div>
                        <div>08am</div>
                        <div>09am</div>
                        <div>10am</div>
                        <div>11am</div>
                        <div>12pm</div>
                        <div>01pm</div>
                        <div>02pm</div>
                        <div>03pm</div>
                        <div>04pm</div>
                        <div>05pm</div>
                        <div>06pm</div>
                        <div>07pm</div>
                        <div>08pm</div>
                        <div>09pm</div>
                        <div>10pm</div>
                        <div>11pm</div>
                    </div>
                    <div class="days flex-1 layout-flex">
                        <div class="day flex-1">
                            <div class="task" draggable="true">Task 4</div>
                            <div class="task" draggable="true">Task 5</div>
                        </div>
                        <div class="day flex-1"></div>
                        <div class="day flex-1"></div>
                        <div class="day flex-1"></div>
                        <div class="day flex-1"></div>
                    </div>
                    <div class="time-now">
                        <span></span>
                    </div>
                    <div class="time-highlight"></div>
                    <div class="time-highlight"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const dragzones = [
            document.querySelector(".tasks"),
            ...document.querySelectorAll(".day"),
        ];

        const tasksElm = document.querySelectorAll(".task");

        let dragElm = null;

        for (const dragzone of dragzones) {
            dragzone.addEventListener("dragover", (e) => {
                if (e.target === dragzone) e.preventDefault();
            });
            dragzone.addEventListener("dragenter", (e) => {
                if (e.target === dragzone)
                    e.target.classList.add("drag-target-active");
            });
            dragzone.addEventListener("dragleave", (e) => {
                if (e.target === dragzone)
                    e.target.classList.remove("drag-target-active");
            });
            dragzone.addEventListener("drop", (e) => {
                e.target.classList.remove("drag-target-active");
                if (e.target === dragzone) {
                    e.preventDefault();
                    e.target.appendChild(dragElm);
                }
            });
        }

        for (const task of tasksElm) {
            task.addEventListener("dragstart", (e) => {
                dragElm = e.target;
            });
        }


        const cellSize = 26; // 15 min
        const pixelPerMinute = cellSize / 15;

        const startTimeElm = document.querySelector('#startTime');
        const endTimeElm = document.querySelector('#endTime');

        updateHighlight(startTimeElm.value, endTimeElm.value)

        startTimeElm.addEventListener('change', () => {
            updateHighlight(startTimeElm.value, endTimeElm.value)
        })

        endTimeElm.addEventListener('change', () => {
            updateHighlight(startTimeElm.value, endTimeElm.value)
        })

        function updateHighlight(startTime, endTime) {
            if (!startTime || !endTime) return;

            const startHourMin = startTime.split(':');
            const endHourMin = endTime.split(':');

            const startHour = parseInt(startHourMin[0]);
            const startMin = parseInt(startHourMin[1]);
            const endHour = parseInt(endHourMin[0]);
            const endMin = parseInt(endHourMin[1]);

            const maxDuration = 2496;// 24 * 60 * pixelPerMinute;

            const offset = getOffset(startHour, startMin) * pixelPerMinute
            const duration = getDuration(startHour, startMin, endHour, endMin) * pixelPerMinute

            const highlightElm = document.querySelectorAll('.time-highlight');

            if (duration < 0) {
                highlightElm[0].style.top = offset;
                highlightElm[0].style.height = maxDuration - offset;

                highlightElm[1].style.top = 0;
                highlightElm[1].style.height = getDuration(0, 0, endHour, endMin) * pixelPerMinute
            } else {
                highlightElm[0].style.top = duration === 0 ? 0 : offset;
                highlightElm[0].style.height = duration === 0 ? maxDuration : duration;
                highlightElm[1].style.height = 0
            }
        }



        function getOffset(startHour, startMin) {
            return startHour * 60 + startMin;
        }

        function getDuration(startHour, startMin, endHour, endMin) {
            return (endHour * 60 + endMin) - (startHour * 60 + startMin)
        }



        updateTime();

        function updateTime() {
            const timeGraph = document.querySelector(".wrapper-time-graph");
            const timeNowElm = document.querySelector(".time-now");
            const timeNow = timeNowElm.querySelector("span");

            const now = new Date();

            const hours = now.getHours();
            const min = now.getMinutes();

            // scroll height
            const graphHeight = timeGraph.getClientRects()[0].height - 8;
            const scrollMarginInMinutes = graphHeight / 2 / pixelPerMinute;

            timeGraph.scrollTop =
                Math.max(0, hours * 60 + min - scrollMarginInMinutes) *
                pixelPerMinute;

            updateLinePosition(hours, min);
            displayTime(hours, min);

            setInterval(() => {
                const now = new Date();
                const hours = now.getHours();
                const min = now.getMinutes();

                updateLinePosition(hours, min);
                displayTime(hours, min);
            }, 1000);

            function updateLinePosition(hours, min) {
                // line position
                const height = (hours * 60 + min) * pixelPerMinute;
                timeNowElm.style.top = height;
            }

            function displayTime(hours, min) {
                // display time
                let _12hours = hours % 12;
                if (_12hours === 0) _12hours = 12;

                let ampm = hours >= 12 ? "pm" : "am";

                timeNow.textContent =
                    _12hours.toString().padStart(2, "0") +
                    ":" +
                    min.toString().padStart(2, "0") +
                    ampm;
            }
        }
    </script>
</body>

</html>